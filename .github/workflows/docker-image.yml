name: Build and Publish Docker images

on:
  push:
    branches:
      - main

jobs:
	docker:
 		runs-on: ubuntu-latest

		strategy:
		  matrix:
			include:
			  - image: sertxudeveloper/laravel
			    dockerfile: laravel/Dockerfile
	
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Login to Docker Hub
				uses: docker/login-action@v2
				with:
					username: ${{ secrets.DOCKERHUB_USERNAME }}
					password: ${{ secrets.DOCKERHUB_TOKEN }}

			- name: Install cosign
				uses: sigstore/cosign-installer@59acb6260d9c0ba8f4a2f9d9b48431a222b68e20 #v3.5.0
				with:
					cosign-release: 'v2.2.4'

			- name: Extract metadata (tags, labels) for Docker
				id: meta
				uses: docker/metadata-action@v4
				with:
					images: ${{ matrix.image }}

			- name: Build and push
				id: build-and-push
				uses: docker/build-push-action@v4
				with:
					context: .
					file: ${{ matrix.dockerfile }}
					push: true
					tags: ${{ steps.meta.outputs.tags }}
					labels: ${{ steps.meta.outputs.labels }}
					cache-from: type=gha
					cache-to: type=gha,mode=max

			- name: Sign the published Docker image
				env:
					TAGS: ${{ steps.meta.outputs.tags }}
					DIGEST: ${{ steps.build-and-push.outputs.digest }}
				run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}
